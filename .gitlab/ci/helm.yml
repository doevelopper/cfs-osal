#         cfs-com/.gitlab/ci/globals.yml
#
#               Copyright (c) 2014-2018 A.H.L
#
#        Permission is hereby granted, free of charge, to any person obtaining
#        a copy of this software and associated documentation files (the
#        "Software"), to deal in the Software without restriction, including
#        without limitation the rights to use, copy, modify, merge, publish,
#        distribute, sublicense, and/or sell copies of the Software, and to
#        permit persons to whom the Software is furnished to do so, subject to
#        the following conditions:
#
#        The above copyright notice and this permission notice shall be
#        included in all copies or substantial portions of the Software.
#
#        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#        EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#        MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#        NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#        LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#        OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#        WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

image: docker:git

variables:
  HELM_CHART_NAME: ship
  HELM_REPO_NAME: maven.dist.acme
  USERNAME: $MAVEN_REPO_USER
  PASSWORD: $MAVEN_REPO_PASS
  AUTH: $MAVEN_REPO_USER:$MAVEN_REPO_PASS

services:
  - docker:dind

stages:
  - deploy

before_script:
  - mkdir -p .helm_config/plugins
  #- git clone $HELM_NEXUS_PUSH .helm_config/plugins/helm-nexus-push
  - docker login -u $DOCKER_REPO_USER -p $DOCKER_REPO_PASS $DOCKER_REPO
  - alias helm="docker run -e HTTP_PROXY -e HTTPS_PROXY -e USERNAME -e PASSWORD -e AUTH -i -v $CI_PROJECT_DIR:/root/$HELM_CHART_NAME -v $CI_PROJECT_DIR/.helm_config:/root/.helm $DOCKER_REPO/helm:2.11.0"

deploy-helm:
  image: docker:git
  stage: deploy
  script:
    # we need to do this bullshit because of senseless helm linter
    # https://github.com/helm/helm/issues/1979
    # already fixed in version 3, we dont use it yet because of ...
    # - cd .. && mv $CI_PROJECT_NAME $HELM_CHART_NAME && cd $HELM_CHART_NAME
    - helm init --client-only
    - helm repo add $HELM_REPO_NAME $HELM_REPO
    - helm plugin install --version master $HELM_NEXUS_PUSH
    - helm nexus-push $HELM_REPO_NAME /root/$HELM_CHART_NAME
  only:
    - master
